name: AIC Data Ingestion Pipeline

on:
  schedule:
    # Run every 8 hours (0:00, 8:00, 16:00 UTC)
    - cron: '0 */8 * * *'
  
  workflow_dispatch:  # Allow manual triggering
    inputs:
      max_events:
        description: 'Maximum events to fetch'
        required: false
        default: 'None'
      num_of_hours:
        description: 'Number of hours to fetch'
        required: false
        default: '8'

jobs:
  ingest-and-process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Set persist-credentials to false to allow pushing with GITHUB_TOKEN
          persist-credentials: false
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "ingest/uv.lock"

      - name: Set up Python
        run: uv python install 3.12

      - name: Run Ingestion Pipeline
        run: |
          cd ingest/src
          uv run main.py
        continue-on-error: false
      
      - name: Generate data manifest
        run: |
          # Create a simple manifest for cache busting
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{\"last_update\": \"$TIMESTAMP\", \"commit\": \"$GITHUB_SHA\"}" > data/manifest.json
      
      - name: Commit and push changes
        run: |
          git config user.name "AIC Bot"
          git config user.email "AIC-bot@users.noreply.github.com"
          
          # Add only the data directory
          git add data/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Commit with timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ðŸ¤– Data update: $TIMESTAMP

          - Fetched latest GDELT events
          - Aggregated to H3 grid
          - Exported optimized layers
          
          Generated by workflow: $GITHUB_RUN_NUMBER"
          
          # Push to main branch
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy summary
        run: |
          echo "## ðŸŽ‰ Data Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated files:**" >> $GITHUB_STEP_SUMMARY
          echo "- Core grid: \`data/h3_grid_res*.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Vibe scores: \`data/vibe_scores.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Events sample: \`data/events_sample.json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get file sizes
          if [ -f data/h3_grid_res3.json ]; then
            GRID_SIZE=$(du -h data/h3_grid_res3.json | cut -f1)
            echo "**Core Grid Size:** $GRID_SIZE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/vibe_scores.json ]; then
            SCORES_SIZE=$(du -h data/vibe_scores.json | cut -f1)
            echo "**Vibe Scores Size:** $SCORES_SIZE" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next update:** In 8 hours" >> $GITHUB_STEP_SUMMARY